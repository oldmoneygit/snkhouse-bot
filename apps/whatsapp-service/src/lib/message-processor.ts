import { generateResponseWithFallback } from '@snkhouse/ai-agent';
import type { ConversationMessage } from '@snkhouse/ai-agent';
import { WhatsAppClient } from '@snkhouse/integrations';
import type { Message, WebhookValue } from './types';
import {
  findOrCreateCustomer,
} from './customer-helper';
import {
  getOrCreateConversation,
  getConversationHistory,
  saveMessage,
  isMessageProcessed,
} from './conversation-helper';

// Inicializar WhatsApp client
const whatsappClient = new WhatsAppClient({
  phoneNumberId: process.env.WHATSAPP_PHONE_NUMBER_ID!,
  accessToken: process.env.WHATSAPP_ACCESS_TOKEN!,
});

/**
 * Processa uma mensagem recebida do WhatsApp
 * COM MEM√ìRIA DE CONVERSA√á√ÉO E DEBUG LOGGING
 */
export async function processIncomingWhatsAppMessage(
  message: Message,
  value: WebhookValue
): Promise<void> {

  console.log('[MessageProcessor] üöÄ Starting processing WITH DATABASE AND MEMORY...');

  try {
    const from = message.from;
    const messageBody = message.text?.body;
    const messageId = message.id;

    if (!messageBody) {
      console.log('[MessageProcessor] ‚ö†Ô∏è No text message, skipping');
      return;
    }

    const contactName = value.contacts?.[0]?.profile?.name || 'Cliente';

    console.log('[MessageProcessor] üìã Message received:', {
      from: from.slice(0, 4) + '***',
      name: contactName,
      text: messageBody,
      messageId: messageId.slice(0, 20) + '...'
    });

    // =====================================================
    // üîç DEBUG #1: Check if message already processed
    // =====================================================
    console.log('üîç DEBUG #1 - Checking for duplicate message...');
    const alreadyProcessed = await isMessageProcessed(messageId);
    if (alreadyProcessed) {
      console.log('[MessageProcessor] ‚ö†Ô∏è Message already processed, skipping');
      return;
    }
    console.log('‚úÖ DEBUG #1 - Message is new, proceeding');

    // =====================================================
    // üîç DEBUG #2: Get or create customer
    // =====================================================
    console.log('üîç DEBUG #2 - Finding or creating customer...');
    const customer = await findOrCreateCustomer({
      phone: from,
      whatsappName: contactName,
      waId: from,
    });
    console.log('‚úÖ DEBUG #2 - Customer retrieved:', {
      id: customer.id,
      email: customer.email || 'NO EMAIL',
      wooCustomerId: customer.woocommerce_customer_id || 'NO WOO ID'
    });

    // =====================================================
    // üîç DEBUG #3: Get or create conversation
    // =====================================================
    console.log('üîç DEBUG #3 - Finding or creating conversation...');
    const conversation = await getOrCreateConversation({
      customerId: customer.id,
      phone: from,
      waId: from,
    });
    console.log('‚úÖ DEBUG #3 - Conversation retrieved:', {
      id: conversation.id,
      status: conversation.status,
      created: conversation.created_at,
      updated: conversation.updated_at
    });

    // =====================================================
    // üÜî DEBUG: Confirm conversation_id consistency
    // =====================================================
    console.log('üÜî DEBUG - CONVERSATION ID CONSISTENCY CHECK:');
    console.log('üÜî   conversation.id:', conversation.id);
    console.log('üÜî   This ID will be used for ALL database operations');

    // =====================================================
    // üîç DEBUG #4: Save user message
    // =====================================================
    console.log('üîç DEBUG #4 - Saving user message to database...');
    const savedUserMessage = await saveMessage({
      conversationId: conversation.id,
      role: 'user',
      content: messageBody,
      whatsappMessageId: messageId,
    });
    console.log('‚úÖ DEBUG #4 - User message saved:', {
      messageDbId: savedUserMessage.id,
      conversationId: savedUserMessage.conversation_id,
      role: savedUserMessage.role
    });

    // =====================================================
    // üîç DEBUG #5: Load conversation history
    // =====================================================
    console.log('üîç DEBUG #5 - Loading conversation history...');
    console.log('üîç   Querying messages WHERE conversation_id =', conversation.id);

    const history = await getConversationHistory(conversation.id);

    console.log('‚úÖ DEBUG #5 - History loaded:', {
      messageCount: history.length,
      conversationId: conversation.id
    });

    if (history.length === 0) {
      console.log('‚ö†Ô∏è DEBUG #5 - WARNING: NO HISTORY FOUND!');
      console.log('‚ö†Ô∏è   This could indicate a database query issue');
    } else {
      console.log('üìú DEBUG #5 - History preview (last 3 messages):');
      history.slice(-3).forEach((msg, idx) => {
        console.log(`üìú   [${idx + 1}] ${msg.role}: ${msg.content.substring(0, 50)}...`);
      });
    }

    // =====================================================
    // üîç DEBUG #6: Prepare messages for AI
    // =====================================================
    console.log('üîç DEBUG #6 - Preparing messages for Claude...');

    const aiMessages: ConversationMessage[] = [
      ...history.map((msg) => ({
        role: msg.role as 'user' | 'assistant',
        content: msg.content,
      })),
      {
        role: 'user' as const,
        content: messageBody,
      },
    ];

    console.log('‚úÖ DEBUG #6 - Messages prepared:', {
      totalMessages: aiMessages.length,
      historyMessages: history.length,
      currentMessage: 1,
      firstMessage: aiMessages[0] ? {
        role: aiMessages[0].role,
        preview: aiMessages[0].content.substring(0, 30) + '...'
      } : 'NONE',
      lastMessage: {
        role: aiMessages[aiMessages.length - 1].role,
        preview: aiMessages[aiMessages.length - 1].content.substring(0, 30) + '...'
      }
    });

    // Context for AI
    const context = {
      conversationId: conversation.id,
      customerId: customer.woocommerce_customer_id || undefined,
      customerEmail: customer.email || undefined,
    };

    console.log('[MessageProcessor] üìã Context for AI:', {
      conversationId: context.conversationId,
      customerId: context.customerId || 'NO WOO ID',
      customerEmail: context.customerEmail || 'NO EMAIL'
    });

    console.log('[MessageProcessor] ü§ñ Processing with AI Agent...', {
      messageCount: aiMessages.length,
      context
    });

    const response = await generateResponseWithFallback(aiMessages, context);

    console.log('‚úÖ DEBUG #7 - AI Response received:', {
      length: response.content.length,
      model: response.model,
      preview: response.content.substring(0, 100) + '...'
    });

    // =====================================================
    // üî¥ PRIORIDADE #1: ENVIAR MENSAGEM IMEDIATAMENTE!
    // =====================================================
    console.log('[MessageProcessor] üì§ PRIORITY: Sending WhatsApp message FIRST...');
    console.log('[MessageProcessor] üîë Checking WhatsApp credentials...');
    console.log('[MessageProcessor] üìã Config:', {
      phoneNumberId: process.env.WHATSAPP_PHONE_NUMBER_ID ? 'SET' : 'MISSING',
      phoneNumberIdValue: process.env.WHATSAPP_PHONE_NUMBER_ID,
      accessToken: process.env.WHATSAPP_ACCESS_TOKEN ?
        'SET (' + process.env.WHATSAPP_ACCESS_TOKEN.substring(0, 15) + '...)' : 'MISSING',
    });

    if (!process.env.WHATSAPP_PHONE_NUMBER_ID || !process.env.WHATSAPP_ACCESS_TOKEN) {
      throw new Error('WhatsApp credentials missing!');
    }

    console.log('[MessageProcessor] üì± Sending to:', from.slice(0, 4) + '***');
    console.log('[MessageProcessor] üí¨ Message length:', response.content.length);
    console.log('[MessageProcessor] üí¨ Message preview:', response.content.substring(0, 100) + '...');

    let sentMessageId: string | undefined;

    try {
      console.log('[MessageProcessor] üì° Calling WhatsApp API...');

      const sendResult = await whatsappClient.sendMessage({
        to: from,
        message: response.content,
      });

      sentMessageId = sendResult.messageId;

      console.log('[MessageProcessor] ‚úÖ‚úÖ‚úÖ MESSAGE SENT SUCCESSFULLY! ‚úÖ‚úÖ‚úÖ');
      console.log('[MessageProcessor] üìä Send result:', {
        messageId: sendResult.messageId?.slice(0, 20) + '...',
        success: !!sendResult.messageId
      });

    } catch (sendError: any) {
      console.error('[MessageProcessor] ‚ùå ERROR SENDING MESSAGE:', {
        name: sendError instanceof Error ? sendError.name : 'Unknown',
        message: sendError instanceof Error ? sendError.message : String(sendError),
        status: sendError.status,
        code: sendError.code,
        stack: sendError instanceof Error ? sendError.stack?.substring(0, 300) : undefined,
      });

      throw sendError; // Re-throw para cair no error handler principal
    }

    // =====================================================
    // üîç DEBUG #8: Save assistant response to database
    // =====================================================
    console.log('üîç DEBUG #8 - Saving assistant response to database...');
    try {
      const savedAssistantMessage = await saveMessage({
        conversationId: conversation.id,
        role: 'assistant',
        content: response.content,
        whatsappMessageId: sentMessageId,
        whatsappStatus: 'sent',
      });

      console.log('‚úÖ DEBUG #8 - Assistant message saved:', {
        messageDbId: savedAssistantMessage.id,
        conversationId: savedAssistantMessage.conversation_id,
        role: savedAssistantMessage.role,
        whatsappMessageId: sentMessageId?.slice(0, 20) + '...' || 'NO ID'
      });

      // Verify message was saved
      console.log('üîç DEBUG #8 - Verifying message in database...');
      const verifyHistory = await getConversationHistory(conversation.id, 2);
      console.log('‚úÖ DEBUG #8 - Current message count in conversation:', verifyHistory.length);

    } catch (saveError: any) {
      console.error('‚ùå DEBUG #8 - Failed to save assistant message:', saveError.message);
      console.error('‚ö†Ô∏è WARNING: Message was sent but NOT saved to database!');
      // Don't throw - message was already sent successfully
    }

    // =====================================================
    // üü° OPCIONAL: Marcar como lida (DEPOIS do envio)
    // =====================================================
    try {
      console.log('[MessageProcessor] üëÅÔ∏è [OPTIONAL] Marking as read...');
      await whatsappClient.markAsRead({ messageId: message.id });
      console.log('[MessageProcessor] ‚úÖ Marked as read');
    } catch (markError: any) {
      console.warn('[MessageProcessor] ‚ö†Ô∏è Failed to mark as read (ignored):', markError.message);
      // N√£o lan√ßar erro - marking as read n√£o √© cr√≠tico
    }

    console.log('[MessageProcessor] üéâüéâüéâ Processing completed successfully! üéâüéâüéâ');
    console.log('[MessageProcessor] üìä FINAL SUMMARY:');
    console.log('[MessageProcessor]   - User message saved: ‚úÖ');
    console.log('[MessageProcessor]   - AI response generated: ‚úÖ');
    console.log('[MessageProcessor]   - WhatsApp message sent: ‚úÖ');
    console.log('[MessageProcessor]   - Assistant message saved: ‚úÖ');
    console.log('[MessageProcessor]   - Conversation ID:', conversation.id);
    console.log('[MessageProcessor]   - Total messages in conversation:', aiMessages.length + 1);

  } catch (error: any) {
    console.error('[MessageProcessor] ‚ùå ERROR:', error);
    console.error('[MessageProcessor] ‚ùå Error stack:', error instanceof Error ? error.stack : 'No stack trace');
    console.error('[MessageProcessor] ‚ùå Error details:', {
      name: error instanceof Error ? error.name : 'Unknown',
      message: error instanceof Error ? error.message : String(error),
      type: typeof error
    });

    // Em caso de erro, tentar enviar mensagem gen√©rica
    try {
      console.log('[MessageProcessor] üö® Attempting to send error message to user...');

      await whatsappClient.sendMessage({
        to: message.from,
        message: 'Disculp√°, tuve un problema t√©cnico. Intent√° de nuevo en unos minutos. üôè',
      });

      console.log('[MessageProcessor] ‚úÖ Error message sent to user');

    } catch (sendError: any) {
      console.error('[MessageProcessor] ‚ùå Failed to send error message:', sendError);
      console.error('[MessageProcessor] ‚ùå Send error details:', {
        name: sendError instanceof Error ? sendError.name : 'Unknown',
        message: sendError instanceof Error ? sendError.message : String(sendError)
      });
    }
  }
}

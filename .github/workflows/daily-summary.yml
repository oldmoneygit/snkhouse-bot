name: Daily Summary

on:
  schedule:
    - cron: '0 21 * * *'
  workflow_dispatch:

jobs:
  create-summary:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate summary
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 86400000).toISOString();
            
            const { data: closedToday } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              since: yesterday,
              per_page: 100
            });
            
            const { data: openIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            
            const sprintIssues = openIssues.filter(i => 
              i.labels.some(l => l.name.includes('week-'))
            );
            
            const { data: commits } = await github.rest.repos.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              since: yesterday,
              per_page: 10
            });
            
            const { data: allIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              per_page: 100
            });
            
            const allSprintIssues = allIssues.filter(i => 
              i.labels.some(l => l.name.includes('week-'))
            );
            
            const total = allSprintIssues.length;
            const closed = allSprintIssues.filter(i => i.state === 'closed').length;
            const progress = total > 0 ? Math.round((closed / total) * 100) : 0;
            
            const body = `# 📊 Daily Summary - ${today}

## ✅ Completed Today (${closedToday.length})
${closedToday.length > 0 ? closedToday.map(i => `- #${i.number} ${i.title}`).join('\n') : 'None'}

## 🔄 In Progress (${sprintIssues.filter(i => i.assignees.length > 0).length})
${sprintIssues.filter(i => i.assignees.length > 0).slice(0, 5).map(i => `- #${i.number} ${i.title}`).join('\n') || 'None'}

## ⏳ Todo (${sprintIssues.filter(i => i.assignees.length === 0).length})
${sprintIssues.filter(i => i.assignees.length === 0).slice(0, 5).map(i => `- #${i.number} ${i.title}`).join('\n') || 'None'}

## 💻 Commits Today (${commits.length})
${commits.slice(0, 5).map(c => `- ${c.commit.message.split('\n')[0]}`).join('\n') || 'None'}

## 📊 Sprint Progress
Overall: ${'█'.repeat(Math.floor(progress/10))}${'░'.repeat(10-Math.floor(progress/10))} ${progress}% (${closed}/${total})

## 🎯 Tomorrow's Focus
${sprintIssues.filter(i => i.assignees.length === 0).slice(0, 3).map((i, idx) => `${idx + 1}. #${i.number} ${i.title}`).join('\n') || 'No pending tasks'}

---
*Auto-generated by GitHub Actions*`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `📊 Daily Summary - ${today}`,
              body: body,
              labels: ['📊 summary', 'automated']
            });

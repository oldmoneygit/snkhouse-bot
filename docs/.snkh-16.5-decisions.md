# SNKH-16.5: Orders Tools - Key Decisions & Context

**Status:** ‚úÖ Completed
**Date:** 2025-01-10
**Version:** 0.8.0
**Implementation:** Claude Code

---

## üìã CONTEXT

AI Agent needed access to WooCommerce orders to answer customer questions about order status, tracking, and history.

---

## üéØ KEY DECISIONS

### 1. **READ-ONLY Only (Phase 1)**
- **Decision:** Implement only query operations, no write operations
- **Rationale:**
  - Lower security risk
  - Easier to test and validate
  - Write operations (cancel, refund) require user confirmation flow
  - Can be added in Phase 2 after WhatsApp integration (SNKH-17)

### 2. **Customer ID Validation on ALL Queries**
- **Decision:** Validate `customer_id` matches `order.customer_id` before returning ANY data
- **Rationale:**
  - **CRITICAL SECURITY:** Prevent unauthorized access to other customers' orders
  - Implemented in `validateOrderOwnership()` function
  - Throws error if mismatch detected
  - Logged with sanitized IDs for audit trail

### 3. **Separate Cache with 5-Minute TTL**
- **Decision:** Orders cache separate from products, TTL 5min (vs 30min for products)
- **Rationale:**
  - Order status changes frequently (pending ‚Üí processing ‚Üí shipped)
  - Products data is more stable (price/stock changes slower)
  - Sensitive data requires faster refresh
  - Balance between performance and data freshness

### 4. **Sanitized Logs (LGPD Compliance)**
- **Decision:** Partially mask customer IDs in all logs
- **Implementation:** `sanitizeCustomerId()` converts `12345` ‚Üí `cust_12***5`
- **Rationale:**
  - LGPD compliance (Brazil's GDPR)
  - Logs are readable for debugging but don't expose full IDs
  - Never log: full addresses, CPF, phone, email, payment data

### 5. **SNKH-15 Tracking Integration**
- **Decision:** Integrate metrics tracking in all 4 tools
- **Rationale:**
  - Consistent with existing tools (search_products, etc)
  - Enables performance monitoring
  - Helps identify slow queries or errors
  - Parameters sanitized before tracking

### 6. **4 Specific Tools (Not Generic)**
- **Decision:** 4 specific tools instead of 1 generic `query_order()`
- **Tools:**
  1. `get_order_status` - Basic status
  2. `search_customer_orders` - Order history
  3. `get_order_details` - Complete details
  4. `track_shipment` - Tracking info
- **Rationale:**
  - Clear intent for AI to choose correct tool
  - Better tool descriptions for function calling
  - Easier to track which operations are used most
  - Can optimize each tool independently

---

## üèóÔ∏è ARCHITECTURE DECISIONS

### TypeScript Interfaces (9 total)
- **Decision:** Separate `types-orders.ts` file
- **Rationale:**
  - Keep `types.ts` focused on existing structures
  - Orders have many nested types (billing, shipping, line items)
  - Easier to maintain and extend

### Orders Client (`orders.ts`)
- **Decision:** Separate file from `client.ts`
- **Rationale:**
  - `client.ts` handles low-level WooCommerce API
  - `orders.ts` handles business logic (cache, validation, sanitization)
  - Clearer separation of concerns
  - Easier to test in isolation

### Import Path
- **Decision:** Export from `@snkhouse/integrations` (not deep import)
- **Implementation:** Added exports to `woocommerce/index.ts`
- **Rationale:**
  - Consistent with existing patterns
  - Cleaner imports in handlers.ts
  - No webpack/TypeScript path resolution issues

---

## üîê SECURITY CONSIDERATIONS

### What We Implemented:
- ‚úÖ Customer ID validation on EVERY query
- ‚úÖ Sanitized logs (partial masking)
- ‚úÖ Error messages don't leak order details
- ‚úÖ Cache separated by order ID (no cross-customer leaks)
- ‚úÖ HTTPS required (WooCommerce config)

### What's NOT Implemented (Future):
- ‚ùå Rate limiting (rely on WooCommerce API limits)
- ‚ùå Audit trail (logs exist but not persisted to DB)
- ‚ùå IP-based access control
- ‚ùå 2FA for sensitive operations (write operations - Phase 2)

### Why It's Safe:
- READ-ONLY operations only
- No way to modify orders from AI agent
- Customer can only see their own orders
- All queries logged for security audit

---

## üìä PERFORMANCE DECISIONS

### Cache Strategy:
- **TTL:** 5 minutes
- **Keys:** `order_${orderId}`
- **Cleanup:** Auto-cleanup on every query
- **Invalidation:** Manual via `invalidateOrderCache(orderId)`

**Why this works:**
- 5min is long enough to cache repeated queries in same conversation
- Short enough that status updates appear reasonably fast
- Cache hit reduces WooCommerce API calls (rate limit)
- Customer sees fresh data within acceptable delay

### Estimated Performance:
- **Without cache:** 200-400ms (WooCommerce API latency)
- **With cache:** 1-5ms (in-memory lookup)
- **Cache hit rate (expected):** 60-70% after warmup

---

## üß™ TESTING DECISIONS

### Test Script (`test-orders-tools.ts`)
- **Decision:** Simple standalone script (not Jest/Mocha)
- **Rationale:**
  - Quick to run: `pnpm tsx script.ts`
  - No test framework dependencies
  - Easy to understand for future devs
  - Can run in CI/CD without setup

### Mock-Friendly Design:
- All functions accept parameters (not globals)
- No hard-coded IDs in production code
- Test script has placeholder IDs with clear comments
- Security test included (invalid customer_id)

---

## üìù DOCUMENTATION DECISIONS

### Complete Documentation (`docs/16.5-orders-tools.md`)
- **Sections:**
  - Overview & objectives
  - Each tool explained with examples
  - Security guidelines (critical section)
  - Architecture overview
  - Testing instructions
  - Future roadmap (Phase 2)
- **Rationale:**
  - Future developers need context on "why" decisions were made
  - Security is critical - needs explicit documentation
  - Phase 2 planning helps avoid rework

### CHANGELOG Update
- **Decision:** Added full entry to CHANGELOG.md
- **Rationale:**
  - Keep changelog current for releases
  - Users can see what's new in 0.8.0
  - Links to detailed docs

---

## üîÆ FUTURE CONSIDERATIONS

### Phase 2 - Write Operations (After SNKH-17 WhatsApp):

#### `cancel_order(order_id, customer_id, reason)`
- **Requirements:**
  - User confirmation required (not auto-execute)
  - Window of time (e.g., can only cancel within 24h of order)
  - Notify admin via email/webhook
  - Full audit trail (who, when, why)
  - Rate limit (max X cancellations per day)

#### `update_shipping_address(order_id, customer_id, new_address)`
- **Requirements:**
  - Only if order not yet shipped
  - User confirmation required
  - Validate address format
  - Notify admin
  - Audit trail

#### `request_refund(order_id, customer_id, reason, items?)`
- **Requirements:**
  - Can request full or partial refund
  - Goes to admin for approval (not auto-approved)
  - User confirmation required
  - Notify admin immediately
  - Full audit trail

**All write operations:**
- ‚ùå NEVER auto-execute from AI
- ‚úÖ ALWAYS require explicit user confirmation
- ‚úÖ ALWAYS notify admin
- ‚úÖ ALWAYS create audit trail
- ‚úÖ ALWAYS have rate limiting

---

## üìä METRICS TO MONITOR

Once deployed, monitor:

1. **Tool Usage:**
   - Which tools are used most?
   - Are customers asking about orders often?

2. **Performance:**
   - Average execution time per tool
   - Cache hit rate
   - WooCommerce API errors

3. **Security:**
   - Any unauthorized access attempts?
   - Logs showing `customer_id` mismatch errors

4. **Customer Satisfaction:**
   - Did orders tools reduce support tickets?
   - Are customers satisfied with order info from AI?

---

## üéØ SUCCESS CRITERIA MET

- [x] 4 tools READ-ONLY implemented
- [x] Customer ID validation on ALL queries
- [x] Logs sanitized (LGPD)
- [x] Cache implemented (5min TTL)
- [x] Tracking integrated (SNKH-15)
- [x] Error handling robust
- [x] Types TypeScript complete
- [x] Tests created (5 tests)
- [x] Documentation complete
- [x] CHANGELOG updated
- [x] Commit created with clear message

**Status:** ‚úÖ **PRODUCTION READY**

---

## üìö REFERENCES

- [WooCommerce Orders REST API](https://woocommerce.github.io/woocommerce-rest-api-docs/#orders)
- [SNKH-15: Metrics Collection](./15-metrics-collection.md)
- [SNKH-16: Knowledge Base System](./16-knowledge-base-system.md)
- [Security Guidelines](./SECURITY.md)

---

**Implemented by:** Claude Code
**Approved:** 2025-01-10
**Version:** 0.8.0
**Commit:** 0908a42
